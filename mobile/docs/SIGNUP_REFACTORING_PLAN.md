# 회원가입 리팩토링 계획서

## 1. 개요

### 변경 요약

| 항목 | 현재 | 변경 후 |
|------|------|---------|
| 이름 | 있음 (미사용) | Optional (프로필에서 수정) |
| 이메일 | 필수 | 필수 + **이메일 인증** |
| 생년월일 | 있음 | **제거** |
| 휴대전화 | 있음 | **제거** |
| 비밀번호 | 필수 (6자) | 필수 (**8자 이상**) |
| 비밀번호 확인 | 없음 | **추가** |

### 이메일 인증 규칙
- 6자리 숫자 코드
- 유효시간: 60분
- 재발송: 1번은 바로 가능, 이후 60초 대기
- 시도 제한: 5회 실패 시 재발송 필요

### 결정 사항

| 항목 | 결정 |
|------|------|
| 이메일 발송 | Gmail SMTP (우선), K8s 무료 솔루션은 추후 검토 |
| 비밀번호 규칙 | **8자 이상** |
| 이름 입력 | 회원가입 시 Optional, **프로필에서 수정 가능** |
| 중복 이메일 | **A. 허용** (email + login_method 조합 유지) |

---

## 2. Phase 1: Server API

### 수정 대상

| 파일 | 변경 |
|------|------|
| `users/models.py` | EmailVerification 모델 추가 |
| `users/api.py` | 이메일 인증 API 추가 |
| `users/schemas.py` | 인증 스키마 추가 |
| `config/settings.py` | 이메일 발송 설정 |

### API 엔드포인트

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/auth/email/send-code` | 인증코드 발송 |
| POST | `/auth/email/verify-code` | 인증코드 확인 → verification_token 반환 |
| POST | `/auth/signup` | 회원가입 (verification_token 필수) |

### Phase 1 체크리스트
- [x] EmailVerification 모델 + 마이그레이션
- [x] 이메일 발송 설정 (Gmail SMTP)
- [x] send-code API (재발송: 첫 번째 바로, 이후 60초)
- [x] verify-code API
- [x] signup API 수정 (비밀번호 8자 이상)

---

## 3. Phase 2: Mobile UI

### 수정 대상

| 파일 | 변경 |
|------|------|
| `sign_up_screen.dart` | UI 전면 수정 |
| `auth_service.dart` | 이메일 인증 메서드 추가 |
| `auth_models.dart` | 인증 모델 추가 |

### UI 변경사항
- 생년월일, 휴대전화 필드 제거
- 이름 필드 "(선택)" 표시
- 이메일 옆 "발송" 버튼 추가
- 인증코드 입력 필드 + 타이머(60분) 추가
- 재발송 버튼 (첫 번째 바로 활성화, 이후 60초 대기)
- 비밀번호 확인 필드 추가
- 비밀번호 **8자 이상** 유효성 검사

### Phase 2 체크리스트
- [x] 모델 추가
- [x] AuthService 메서드 추가
- [x] UI 리팩토링
- [x] 비밀번호 규칙 변경 (6자 → 8자)

---

## 4. Phase 3: 테스트 및 배포

### 테스트 항목

| 구분 | 항목 |
|------|------|
| Server | 인증코드 발송/검증, 코드 만료(60분), 재발송 로직, 비밀번호 8자 검증 |
| Mobile | 발송 버튼, 타이머(60분), 재발송(첫번째/이후 구분), 비밀번호 일치 |

### Phase 3 체크리스트

#### Server 테스트 (24개 테스트 케이스)
- [x] send-code API 테스트 (6개)
  - [x] 정상 발송
  - [x] 첫 번째 재발송 (쿨다운 없음)
  - [x] 두 번째 이후 재발송 (60초 쿨다운)
  - [x] 이메일 형식 검증
  - [x] 이미 가입된 이메일 거부
  - [x] 이메일 발송 실패 처리
- [x] verify-code API 테스트 (6개)
  - [x] 정상 인증
  - [x] 잘못된 코드
  - [x] 만료된 코드
  - [x] 5회 시도 초과
  - [x] 존재하지 않는 인증 요청
  - [x] verification_token 발급
- [x] signup API 테스트 (9개)
  - [x] 인증 완료 후 정상 회원가입
  - [x] verification_token 없이 시도
  - [x] 잘못된 verification_token
  - [x] 8자 미만 비밀번호 거부
  - [x] 이미 가입된 이메일 거부
  - [x] 이름 포함 회원가입
  - [x] 이름 없이 회원가입
  - [x] 회원가입 후 인증 레코드 삭제
  - [x] JWT 토큰 발급 확인
- [x] 모델 테스트 (2개)
- [x] 통합 테스트 (2개)

#### Mobile 테스트
- [ ] 발송 버튼 UI 테스트
- [ ] 타이머(60분) 표시 테스트
- [ ] 재발송 쿨다운 UI 테스트
- [ ] 비밀번호 일치 검증 테스트

### 배포 순서
1. Server 배포 (마이그레이션 → 환경변수 → API)
2. Mobile 배포 (스테이징 → TestFlight/내부테스트 → 프로덕션)

---

## 5. 승인

- [ ] 전체 플로우
- [x] Phase 1 (Server)
- [x] Phase 2 (Mobile)
- [ ] Phase 3 (테스트/배포)

---

**작성일**: 2025-11-27 | **버전**: 1.2
